---
output:
  html_document: default
  pdf_document: default
---

#### Isabella Sun

#### Winter 2018

#### Data source: World Bank LSMS Tanzania - National Panel Survey 2014-2015
#### Downloadable at the World Bank website : http://microdata.worldbank.org/index.php/catalog/2862



######PART 1. BRING IN DATA



Bring in first data set. Tanzania household consumption
```{r}
library(readxl)
temp = tempfile(fileext = ".xlsx") # use always with Excel
dataURL <- "https://github.com/ihsun-uw/Assignment-1/raw/master/consumptionnps4.xlsx" # link to data
download.file(dataURL, destfile=temp, mode='wb')  # file will be downloaded temporarily

cons = read_excel(temp, sheet =1)
cons=as.data.frame(cons)
```

Bring in second data set. Tanzania education of individuals in the household
```{r}
temp = tempfile(fileext = ".xlsx") # use always with Excel
dataURL <- "https://github.com/ihsun-uw/Assignment-1/raw/master/Education.xlsx" # link to data
download.file(dataURL, destfile=temp, mode='wb')  # file will be downloaded temporarily

educ = read_excel(temp, sheet =1)
educ=as.data.frame(educ)
```

Third data set. Information about the individuals in each household. We want the gender of the head of household
```{r}

temp = tempfile(fileext = ".xlsx") # use always with Excel
dataURL <- "https://github.com/ihsun-uw/Assignment-1/raw/master/individual.xlsx" # link to data
download.file(dataURL, destfile=temp, mode='wb')  # file will be downloaded temporarily

indiv = read_excel(temp, sheet =1)
indiv=as.data.frame(indiv)

```



######PART 2. MERGING DATA 



Look at names of variables in consumption data
```{r, eval=FALSE}
names(cons)
```

New data frame with only necessary variables from consumption data
```{r}
cons=cons[,c("y4_hhid", "expmR", "adulteq", "region")]

```

look at names of variables in education data
```{r, eval=FALSE}
names(educ)
```
saving new data frame with only necessary variables from education data
```{r}
educ=educ[,c("y4_hhid", "indidy4", "hh_c02", "hh_c03", "hh_c07")]

```

Looking at names of variables in characteristics data
```{r, eval=FALSE}
names(indiv)
```
keeping only necessary variables from the individual characteristics data
```{r}
indiv=indiv[,c("y4_hhid", "indidy4", "hh_b02")]
```

Collapsing education data frame to only include heads of household
```{r}
educ=educ[educ$indidy4==1,]
```

Collapsing individual characteristics data frame to only include head of household so we can merge 
```{r}
indiv=indiv[indiv$indidy4==1,]
```

Merge data by household ID. 
```{r}
merge1=merge(cons, educ)

alldata=merge(merge1, indiv)
```



######PART 3. EXPLORE THE DATA



Section 3.1 UNIVARTIATE ANALYSIS

Create new variable for consumption per household equivalent (consumption per capita)
```{r}

alldata$cons=alldata$expmR/alldata$adulteq

```


Explore main variable of interest - consumption

Summary statistics
```{r}
summary(alldata$'cons')
```

standard deviation
```{r}
sd(alldata$'cons',na.rm = T)
```

Create histogram with lines for mean and median
```{r}
data=alldata[is.finite(alldata$'cons'),]

var=alldata$'cons'

mnVar=mean(var,na.rm = T)
sdVar=sd(var,na.rm = T)

library(ggplot2)

base = ggplot(data, aes(x=var))
hist = base + geom_histogram(fill="green", 
                             color='grey',
                          aes(y=..density..))


histAndNormal = hist + stat_function(fun=dnorm,
                                     color="red",
                                     args=list(mean=mnVar,sd=sdVar))

histAndNormal


mdVar=median(var)

histAndNormal + geom_vline(aes(xintercept = mnVar,colour="mean"),
                           show.legend  = TRUE) + 
                geom_vline(aes(xintercept = mdVar,colour="median"),
                           show.legend  = TRUE) + 
                scale_color_manual(name = "centrals", 
                                   values = c(median = "blue", mean = "red"))
```


Section 3.2 Bivariate Analysis

3.2.1 Clean data- Gender of head of household 

look at distrubution of gender of head of household
```{r}
table(alldata$hh_b02)
```

recode variables 1=male 2=female
keep numerical and change to 0 and 1 so can get proportions when we aggregate at the region level
```{r}
alldata$gender.name[alldata$hh_b02==1] <- "male"
alldata$gender.name[alldata$hh_b02==2] <- "female"

alldata$gender[alldata$hh_b02==1] <- 0
alldata$gender[alldata$hh_b02==2] <- 1

```

Check variable type
```{r}
str(alldata)
```

Gender needs to be a numeric
```{r}
alldata$gender=as.numeric(alldata$gender)
```

Check variable type
```{r}
str(alldata)
```

3.2.2 Bivariate analysis - gender and household consumption

scatterplot of gender and consumption. Is there a difference?
```{r}
library(ggplot2) 

indiv = alldata[alldata$indidy4==1,]
p <- ggplot(indiv, aes(gender.name, cons))

p + geom_boxplot() + labs(title="Are the mean consumption different between male headed households and female headed households?")

```

3.2.3 Clean data- education level of head of household 

recode education. categorical variable
```{r}
alldata$educ[alldata$hh_c03==2] <- 0
alldata$educ[alldata$hh_c07<17] <- 1
alldata$educ[alldata$hh_c07==17] <-2  #typical primary education is 7 years
alldata$educ[alldata$hh_c07==18] <-2
alldata$educ[alldata$hh_c07>=21 & alldata$hh_c07<25] <- 3
alldata$educ[alldata$hh_c07==24] <-4
alldata$educ[alldata$hh_c07>=31 & alldata$hh_c07<34] <- 5
alldata$educ[alldata$hh_c07==32] <-6
alldata$educ[alldata$hh_c07==34] <-6
alldata$educ[alldata$hh_c07>34] <- 7

```

```{r}
str(alldata)
```

recode education level. categorical variable with names of categories
```{r}
alldata$educ1[alldata$educ=="0"] <- "no education"
alldata$educ1[alldata$educ=="1"] <- "some primary"
alldata$educ1[alldata$educ=="2"] <- "completed primary"
alldata$educ1[alldata$educ=="3"] <- "some secondary ordinary level"
alldata$educ1[alldata$educ=="4"] <- "completed secondary ordinary level"
alldata$educ1[alldata$educ=="5"] <- "some secondary advanced level"
alldata$educ1[alldata$educ=="6"] <- "completed secondary advanced level"
alldata$educ1[alldata$educ=="7"] <- "some higher education"

```

```{r}
str(alldata)
```

Making the variable an ordinal categorical variable
```{r}
levelCat=c("no education", "some primary", "completed primary", "some secondary ordinary level", "completed secondary orginary level", "some secondary advanced level", "completed secondary advanced level", "some higher education" )


levelCat
```


```{r}
alldata$educ1=factor(alldata$educ1,
                             levels = levelCat,
                             labels=levelCat,ordered=T)

str(alldata)

```

examine education variable
```{r}
summary(alldata$educ)

table(alldata$educ1)
```

```{r}
seMean = function(x) sd(x)/sqrt(length(x))

# Means by group
means=aggregate(list(mean=alldata$expmR),
          list(educ=alldata$educ1),mean)

# se by group: (I am using my fucntion here)
sems=aggregate(list(seMean=alldata$expmR),
          list(educ=alldata$educ1),seMean)

# a new data frame:
data=merge(means,sems) # party is the assumed 'key'

# adding confidence interval limits:
data$lower=data$mean-2*data$seMean
data$upper=data$mean+2*data$seMean


indiv = alldata[alldata$indidy4==1,]
p <- ggplot(indiv, aes(educ1, cons))

p + geom_boxplot() + labs(title="Is mean consumption different between education level of head of household?")

```

Just for fun, lets try using literacy instead?

```{r}
alldata$literacy[alldata$hh_c03==1] <- 1
alldata$literacy[alldata$hh_c03==2] <- 1
alldata$literacy[alldata$hh_c03==3] <- 1
alldata$literacy[alldata$hh_c03==4] <- 1
alldata$literacy[alldata$hh_c03==5] <- 0

```
explore this variable
```{r}
summary(alldata$literacy)
```
Looks like all heads of household are literate in some language. Not going to give us anything interesting


Create categorical variable for household heads who completed and did not complete a secondary level education
```{r}

alldata$educ2[alldata$educ<4] <- 0
alldata$educ2[alldata$educ>=4] <-1

alldata$educ3[alldata$educ2==0] <- "Did not complete secondary"
alldata$educ3[alldata$educ2==1] <- "Completed secondary"


```

```{r}
library(ggplot2) 

indiv = alldata[alldata$indidy4==1,]
p <- ggplot(indiv, aes(educ3, cons))

p + geom_boxplot() + labs(title="Are the mean consumption different households where the head has completed secondary level education?")
```

Frequency table of consumption by gender and education level of head of houshold
```{r}
tapply(alldata$expmR, list(gender=alldata$gender,education=alldata$educ3), mean)
```

PART 4. AGGREGATE TO REGION LEVEL

Using median consumption level of households by region
```{r}
exp=aggregate(cbind(cons) ~ region, data=alldata, FUN=median)
```

Using mean education and gender - gives us proportion of household heads that are female and proportion of household heads who completed a secondary level education
```{r}
ed=aggregate(cbind(educ2, gender) ~ region, data=alldata, FUN=mean)
```

```{r}
merge2=merge(ed, exp)
```

Correlations
```{r}
res <- cor(merge2[,c(2:4)],use='complete.obs')
round(res, 2)
```

Scatterplots
```{r}
library(car)
scatterplotMatrix(merge2[,c(2:4)], 
   main="Simple Scatterplot Matrix",smoother = F,reg.line = F)
```




######PART 5 Mapping
Source of geo data : http://gadm.org/country

Section 5.1 Merging geo data and other data

Location of shapefile
```{r}
compressedMap= "https://github.com/ihsun-uw/PROJECT/raw/master/Shapefile/TZA_adm_shp.zip"
```

Download and decompress zip file
```{r}
library(utils)
temp=tempfile()
download.file(compressedMap, temp)
unzip(temp)
```

Look at shapefiles 
```{r}
(maps=list.files(pattern = 'shp'))
```

Use admin level 1, which is regions
```{r}
library(rgdal)
TZmap <- rgdal::readOGR("TZA_adm1.shp",stringsAsFactors=F)
```

Look at variable names 
```{r}
names(TZmap)
```

Region name is variable NAME_1
```{r}
str(TZmap$NAME_1)
```

```{r}
TZmap$NAME_1
```

Regions in our data are coded with numbers. Need to recode region names to match shapefile

```{r}
merge2$region.name[merge2$region==1] <-"Dodoma"
merge2$region.name[merge2$region==2] <-"Arusha"
merge2$region.name[merge2$region==3] <-"Kilimanjaro"
merge2$region.name[merge2$region==4] <-"Tanga" 
merge2$region.name[merge2$region==5] <-"Morogoro"
merge2$region.name[merge2$region==6] <-"Pwani"
merge2$region.name[merge2$region==7] <-"Dar es Salaam" 
merge2$region.name[merge2$region==8] <-"Lindi"
merge2$region.name[merge2$region==9] <-"Mtwara"
merge2$region.name[merge2$region==10] <-"Ruvuma"   
merge2$region.name[merge2$region==11] <-"Iringa"
merge2$region.name[merge2$region==12] <-"Mbeya"
merge2$region.name[merge2$region==13] <-"Singida"
merge2$region.name[merge2$region==14] <-"Tabora"
merge2$region.name[merge2$region==15] <-"Rukwa"
merge2$region.name[merge2$region==16] <-"Kigoma" 
merge2$region.name[merge2$region==17] <-"Shinyanga"
merge2$region.name[merge2$region==18] <-"Kagera"
merge2$region.name[merge2$region==19] <-"Mwanza" 
merge2$region.name[merge2$region==20] <-"Mara"
merge2$region.name[merge2$region==21] <-"Manyara"
merge2$region.name[merge2$region==22] <-"Njombe"  
merge2$region.name[merge2$region==23] <-"Katavi"
merge2$region.name[merge2$region==24] <-"Simiyu"
merge2$region.name[merge2$region==25] <-"Geita"

merge2$region.name[merge2$region==51] <-"Zanzibar North"
merge2$region.name[merge2$region==52] <-"Zanzibar South and Central"
merge2$region.name[merge2$region==53] <-"Zanzibar West"
merge2$region.name[merge2$region==54] <-"Pemba North"
merge2$region.name[merge2$region==55] <-"Pemba South"


```

Merge map and data files
```{r}
TZregmap=merge(TZmap, merge2, by.x='NAME_1', by.y='region.name', all.x=F)
```

Checking number of row in shapefile

```{r}
nrow(TZmap)
```

and our data

```{r}
nrow(merge2)
```


Section 5.2 Plotting on map

Install necessary packages to manage color and divisions

```{r}
library(RColorBrewer)
library(classInt)
```

Define input

```{r}
varToPLot=TZregmap$cons
```

```{r}
numberOfClasses = 8
colorForScale='YlGnBu'
colors = brewer.pal(numberOfClasses, colorForScale)
intervals <- classIntervals(varToPLot, numberOfClasses, 
                            style = "quantile",
                            dataPrecision=2)
colorPallette <- findColours(intervals, colors)
```

```{r}
legendText="per capita consumption"
shrinkLegend=0.4
title="Per capita consumption by region"

plot(TZmap,col='red',main=title)
plot(TZregmap, col = colorPallette,border='grey',add=T)

legend('topright', legend = names(attr(colorPallette, "table")), 
       fill = attr(colorPallette, "palette"), cex = shrinkLegend, 
       bty = "n",
       title=legendText)
```

